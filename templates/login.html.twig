<?php
// Démarrer la session en premier
session_start();

// Si l'utilisateur est déjà connecté, le rediriger vers sa page d'accueil
if (!empty($_SESSION['user_id']) && !empty($_SESSION['role'])) {
    // Pour les étudiants, on s'assure de renvoyer l'URL avec le slug
    if ($_SESSION['role'] === 'etudiant' && !empty($_SESSION['slug'])) {
        header('Location: etudiant.php?slug=' . urlencode($_SESSION['slug']));
    } else {
        $redirect = [
            'admin'   => 'admin.php',
            'pilote'  => 'pilote.php',
            'etudiant'=> 'etudiant.php'
        ];
        header('Location: ' . $redirect[$_SESSION['role']]);
    }
    exit();
}

// Inclure la configuration (exemple : connexion à la base de données)
require __DIR__ . '/../config/config.php';

// Initialiser la variable d'erreur
$error = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $email    = trim($_POST['email'] ?? '');
    $password = $_POST['password'] ?? '';

    if (empty($email) || empty($password)) {
        $error = "Veuillez remplir tous les champs.";
    } else {
        try {
            // Recherche l'utilisateur dans la base en fonction de l'email
            $stmt = $pdo->prepare("SELECT * FROM users WHERE email = ?");
            $stmt->execute([$email]);
            $user = $stmt->fetch(PDO::FETCH_ASSOC);

            if ($user && password_verify($password, $user['password'])) {
                // Création de la session avec les infos de l'utilisateur
                $_SESSION = [
                    'user_id' => $user['id'],
                    'role'    => $user['role'],
                    'email'   => $user['email']
                ];

                // Détermination de la redirection selon le rôle de l'utilisateur
                $redirect = 'login.php';
                switch ($user['role']) {
                    case 'etudiant':
                        // Récupère le slug dans la base de données et le stocke en session
                        $stmt = $pdo->prepare("SELECT slug FROM users WHERE id = ?");
                        $stmt->execute([$user['id']]);
                        $slug = $stmt->fetchColumn();
                        $_SESSION['slug'] = $slug;
                        $redirect = 'etudiant.php?slug=' . urlencode($slug);
                        break;
                        
                    case 'admin':
                        $redirect = 'admin.php';
                        break;
                        
                    case 'pilote':
                        $redirect = 'pilote.php';
                        break;
                }

                header("Location: $redirect");
                exit();
            } else {
                $error = "Identifiants incorrects";
            }
        } catch (PDOException $e) {
            $error = "Erreur technique : " . $e->getMessage();
        }
    }
}
?>
{% extends "layout.html.twig" %}

{% block content %}
    <div class="login-container">
      <div
        class="login-body d-md-flex align-items-center justify-content-center"
      >
        <div
          class="login-box d-flex flex-column h-100 align-items-center justify-content-center"
        >
          <div class="mt-5 text-center">
            <?php if (!empty($error)): ?>
                <div class="alert alert-danger" role="alert">
                    <?php echo htmlspecialchars($error); ?>
                </div>
            <?php endif; ?>
            <h3 class="login-title">Se connecter</h3>
            <form class="login-form w-100" method="POST" action="">
              <div class="mb-3">
                <label for="email" class="form-label">Adresse e-mail</label>
                <input
                  type="email"
                  class="form-control"
                  id="email"
                  name="email"
                  placeholder="example@example.com"
                  required
                />
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Mot de passe</label>
                <input
                  type="password"
                  class="form-control"
                  id="password"
                  name="password"
                  placeholder="Mot de passe"
                  required
                />
              </div>
              <button type="submit" class="btn btn-primary w-100">
                Se connecter
              </button>
            </form>
          </div>
          <div class="mt-auto text-center">
            <p class="login-footer text-muted mb-0 mt-md-0 mt-4">
              Vous n'avez pas de compte ?<br />
              <a href="#" class="signup-link">Inscrivez-vous</a>
            </p>
          </div>
        </div>
      </div>
    </div>

{% endblock %}